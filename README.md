# Originallay checker v1.0.0 
## Описание:
##### Тестовый деплой сервиса:
https://originality-checker.onrender.com 

В папке publications сейчас для тестов находится один единственный файл: `test-123`

##### Временный authorization token:
`e704be9a691601ee99a6a483f07f3655c0cbed54e9588ce17abd5ec11fa0c5bf`

### Архитектура:
- Установка соединения 1С с веб-ресурсом происходит по статическому `Bearer` токену,
сгенерированному через `crypto`
- Веб-ресурс написан на фреймворке - `Express.js` (`node.js`) и реализуется по `REST API`архитектуре
- Простое логирование через библиотеку `Morgan` с фильтрацией заголовка `authorization`, чтобы
токен не попадал в логи. В логах отображается кто когда какой запрос сделал, посредством
использования встренного формата `morgan('combined')`. Вывод в консоль и сохранение в
отдельный файл - `access.log`.
- Прием файлов осуществляется через `multer (multipart/form-data)`, с осуществлением валидации
по MIME типу PDF (и JPG в дальнейшем)
- Есть БД `sqlite3`, состоящая из двух таблиц: `logs` и `publications` хранящиеся в файле - `database.sqlite`.
   

   `publications`: Хранит метаданные файлов, имеет следующие поля:
    - documnet_id (type: text)
    - file_id (type: text; PRIMARY_KEY)
    - file_type (type: "actual" OR "deleted")
    - date_of_creation (type: date)
    - status (type: "pending" OR "fulfilled")
    - mime_type (type: "pdf" OR "jpg")
  
   `logs`: Фиксирует действия с файлами, имеет следующие поля:
    - id действия PRIMARY_KEY
    - тип действия (view, upload, delete)
    - IP-адрес
    - User-Agent
    - file_id
    - время события


## API документация:
### Ограничения:
- В запросе `post /api/upload` можно передавать только PDF файлы
- Файл не должен превышать размер в 50Мб

### Доступные запросы:

---
1. `post /api/upload`
   ##### Обязательный заголовок:
   `Authorization: Bearer <STATIC_TOKEN>`
   ##### Тело запроса:

   | Поле           |  Тип данных  |  Required  |
   |:---------------|:------------:|:----------:|
   | `file`         | binary (PDF) |    true    |
   | `document_id`  |    string    |    true    |
   | `file_id`      |    string    |    true    |

   ##### Запрос имеет 3 сценария:
   - **Первая публикация файла на веб-ресурсе с полученными document_id и
   file_id.**\
   Веб-ресурс помечает полученный файл статусом pending (QR-кода ещё нет).
   - **Перезапись файла со статусом pending на файл с QR-кодом.**\
   Веб-ресурс помечает полученный файл статусом fulfilled (файл содержит QR-код).
   - **Запись нового актуального файла вместо файла с таким же documnet_id
   (file_id при этом разные)**\
   Веб-ресурс помечает в БД старый файл как "deleted", а новый, как "actual" и "pending".
   При этом старый файл удаляется, но запись о нём остаётся в БД

   ##### Пример успешного цикла:
   - 1С отправляет PDF → получает ссылку → генерирует QR по ссылке.
   - 1С отправляет файл (тот же file_id) с QR → веб-сервис заменяет его и ставит fulfilled.
   - Позже при новом издании (тот же document_id, другой file_id) веб-сервис помечает старый как deleted и сохраняет новый.
---

2. `get /publications/:file_id`
   ##### Обязательный заголовок:
   Отсутствует (доступ открыт по прямой ссылке)
   ##### Параметры запроса (передаются в url):

   | Поле           |  Тип данных  |  Required  |
   |:---------------|:------------:|:----------:|
   | `file_id`      |    string    |    true    |

   ##### Запрос имеет 3 сценария:
   - **HTTP 200 OK**\
   Если в таблице publications существует запись с данным file_id и file_type
   == 'actual', то возвращается сам PDF-файл с заголовком Content-Type:
   application/pdf
   - **HTTP 410 Gone**\
   Если запись существует, но file_type == 'deleted', то возвращается
   текст: "*The printed form is not relevant*"
   - **HTTP 404 Not Found**\
   Если записи с таким file_id нет вовсе → возвращается текст:
   "*Printable form not found*"
---

3. `get /api/status/:file_id`
   ##### Назначение:
   Получение статуса и метаданных публикации по file_id.
   Используется для отладки и проверки корректности записей в БД.
   ##### Обязательный заголовок
   `Authorization: Bearer <STATIC_TOKEN>`
   ##### Параметры запроса:

   | Поле           |  Тип данных  |  Required  |
   |:---------------|:------------:|:----------:|
   | `file_id`      |    string    |    true    |

   ##### Запрос имеет 2 сценария
   - Если запись с указанным file_id существует, то возвращаются все поля
   из таблицы publications.
   - Если записи нет, то возвращается **HTTP 404 Not Found**,
   { "error": "not found" }.
---

4. `get /api/logs`
   ##### Назначение:
   Возвращает список последних действий из таблицы logs.
   Используется для отладки или административного просмотра активности.
   ##### Обязательный заголовок
   `Authorization: Bearer <STATIC_TOKEN>`
   ##### Параметры запроса:
   Отсутствуют
   ##### Запрос имеет 1 сценарий
    - Возвращает массив до 500 последних записей, отсортированных по дате
    (ts DESC).
---

